<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Responsible Prompting – Multi‐Turn Chat + Graph</title>

    <!-- IBM Plex Sans -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&display=swap"
        rel="stylesheet" />

    <!-- Carbon CSS (for tabs and tags) -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/carbon-components/css/carbon-components.min.css" /> -->

    <link rel="stylesheet" href="./../styles/carbon-components.min.css" />

    <script type="text/javascript" src="./js/d3.v7.min.js"></script>
    <script type="text/javascript" src="./js/jquery-3.7.1.min.js"></script>

    <style>
        /* ================== Global ================== */
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            /* background-color: #f4f4f4; */
            font-family: "IBM Plex Sans", sans-serif;
            color: #161616;
        }

        body {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* center within a max width */
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem 2rem;
            box-sizing: border-box;
        }

        a {
            color: #0f62fe;
            text-decoration: none;
        }

        /* ================== Header & Tabs ================== */
        .header-container {
            /* background: #ffffff; */
            padding-top: 1rem;
            border-bottom: 1px solid #dddddd;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.05);
        }

        .bx--tabs__nav {
            position: relative;
            display: flex;
            list-style: none;
            padding: 0;
            margin-top: 1em;
            border-bottom: 2px solid #c6c6c6;
        }

        .bx--tabs__nav-item {
            text-align: center;
            justify-content: center;
            display: block;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 1rem;
            color: #393939;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            transition: color 0.2s;
        }

        .bx--tabs__nav-item:hover {
            color: #0f62fe;
        }

        .bx--tabs__nav-item--selected {
            font-weight: 600;
            border-bottom: 2px solid #0f62fe !important;
            color: #161616;
        }

        /* ================== Main Content Container ================== */
        .tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* ================== Chat vs. Graph ================== */
        #chat-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            background: #ffffff;
            border-radius: 8px;
            box-sizing: border-box;
            min-height: 0;
        }

        #graph-content {
            display: none;
            flex: 1;
            overflow: auto;
            padding: 1rem;
            background: #ffffff;
            border-radius: 8px;
            box-sizing: border-box;
        }

        /* ================== Chat Container ================== */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        /* ================== Message Bubbles ================== */
        .message {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap;
            position: relative;
            margin-bottom: 0.5rem;
        }

        .message.user {
            background-color: #f2f4f8;
            align-self: flex-end;
            box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
        }

        .message.assistant {
            background-color: white;
            align-self: flex-start;
            padding-left: 2.5rem;
        }

        /* ================== Model Info Bar ================== */
        .model-info {
            font-size: 0.85rem;
            color: #525252;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            background-color: white;
            align-self: flex-start;
        }

        /* ================== Recommendations Tags ================== */
        .recs-container {
            max-width: 70%;
            display: flex;
            flex-wrap: nowrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            scrollbar-width: none; 
            white-space: nowrap;
        }

        .recs-item {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            color: #ffffff;
        }

        .recs-item.add {
            background-color: #24a148;
        }

        .recs-item.remove {
            background-color: #da1e28;
        }

        /* ================== Input Area ================== */
        .input-area {
            border-top: 1px solid #dddddd;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.05);
            gap: 0.5rem;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
            border: 1px solid #c6c6c6;
            border-radius: 0.5rem;
        }

        .input-area:focus-within {
            outline: none;
            border-color: #0f62fe;
            box-shadow: 0px 0px 0px 2px rgba(15, 98, 254, 0.2);
        }

        /* Contenteditable box wrapper */
        #userInput {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* The editable area itself */
        #userInput>div[contenteditable] {
            min-height: 2.5rem;
            font-size: 1rem;
            line-height: 1.5;
            font-family: inherit;
            resize: none;
            background-color: #ffffff;
        }

        [contenteditable]:focus {
            outline: 0px solid transparent;
        }

        div[contenteditable] {
            height: 10vh;
            overflow: scroll;
        }


        /* Send button wrapper */
        .btn {
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: white;
        }

        .btn:disabled {
            cursor: not-allowed;
        }

        .icon {
            width: 1.25rem;
            height: 1.25rem;
        }

        #modelSelect {
            border: 1px solid #c6c6c6;
            border-radius: 5px;
            padding: 0.25rem 0.25rem;
        }

        /* ================== Recommendation Tag Container ================== */
        #recommendation {
            flex: 1;
            font-size: 0.9rem;
            color: #393939;
            display: flex;
            gap: 0.5rem;
            min-height: 1.5rem;
            overflow-x: scroll;
            scrollbar-width: none; 
            white-space: nowrap;
            align-items: center;
        }

        .rec-tags-inputarea {
            flex: 0 0 auto;
        }

        /* ================== Graph Area ================== */
        #graph {
            background: #efefef;
            position: relative;
            min-height: 300px;
            border-radius: 8px;
        }

        .tooltip {
            position: absolute;
            text-align: left;
            padding: 0.5em;
            width: 20em;
            min-height: 5em;
            background: #ffffff;
            color: #000000;
            border: 1px solid #000000;
            border-radius: 5px;
            pointer-events: none;
            font-size: inherit;
            font-family: inherit;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>


    <!-- ===== Header: Title + Carbon Tabs ===== -->
    <div class="header-container">
        <div style="display: flex; flex-direction: row;">
            <h4 style="width: 40%; display: flex; padding-left: 1rem; font-size: xx-large; font-weight: 300;">Responsible Prompting</h4>
            <div style="width: 60%; padding-left: 1rem;" class="intro">
                <p>
                    Please provide a prompt that would be sent to an LLM. Recommendations are performed in prompting-time, before content generation. The recommendations consider a curated dataset of values and prompt sentences. They are based on the similarity between your input and that dataset.
                </p>
            </div>
        </div>
        <ol class="bx--tabs__nav">
            <li id="tab-chat" class="bx--tabs__nav-item bx--tabs__nav-item--selected">
                Chat
            </li>
            <li id="tab-graph" class="bx--tabs__nav-item">
                Graph
            </li>
        </ol>
    </div>
    <!-- <button class="btn bx--btn bx--btn--ghost" style="position: absolute; top: 0; right: 0; margin-top: 0.5rem; margin-right: 0.5rem;">
        <img class="icon" src="./imgs/settings.svg"/>
    </button> -->

    <div class="tab-content">
        <!-- === Chat View === -->
        <div id="chat-content">
            <div id="chat" class="chat-container"></div>

            <!-- Input area -->
            <div class="input-area">
                <div id="userInput">
                    <div id="userInputDiv" contenteditable="true" placeholder="Enter your prompt">Act as a professional designer with 20 years of experience creating and testing UX interfaces and landing sites for a variety of IT applications. We are in need of more people and an increased budget to be able to keep up with clients' needs. What kind of evidence should I gather to support my demands to gain more resources?
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; gap: 1rem;">
                    <div id="recommendation"></div>
                    <select id="modelSelect"></select>
                    <!-- Send button -->
                    <button id="sendBtn" class="btn" disabled>
                        <img src="./imgs/send.svg" alt="Send" class="icon"/>
                    </button>
                </div>
            </div>
            <!-- Under the input row: recommendation tags -->
        </div>

        <!-- === Graph View === -->
        <div id="graph-content">
            <div id="graph"></div>
        </div>
    </div>

    <script>
        const models = [
            { id: 'mistralai/Mistral-7B-Instruct-v0.3', name: 'Mistral 7B Instruct v0.3' },
            { id: 'meta-llama/Llama-4-Scout-17B-16E-Instruct', name: 'Llama 4 Scout' },
            { id: 'meta-llama/Llama-3.3-70B-Instruct', name: 'Llama 3.3 70B Instruct'}
        ];
        function createModelSelect() {
            const modelSelect = document.getElementById('modelSelect');

            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                modelSelect.appendChild(option);
            });
        }

        // Call the function when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', createModelSelect);


        var modelId = models[0].id;
        const modelSelect = document.getElementById('modelSelect');

        modelSelect.addEventListener('change', function() {
            const selectedModel = models.find(model => model.id === this.value);
            modelId = selectedModel.id;
        });
    </script>

    <!-- To show the bottom of text in -->
    <script>
        var objDiv = document.getElementById("userInputDiv");
        objDiv.scrollTop = objDiv.scrollHeight;
        $("#userInputDiv").trigger("input");
    </script>

    <script>
        let lastRecommendations = {
    "add": [
        {
            "prompt": "In your response, suggest ways to build capacity and skills within the community, leading to more self-sufficient and empowered individuals and organizations.",
            "similarity": 0.487290451699556,
            "value": "participation",
            "x": "4.2045746",
            "y": "4.556084"
        },
        {
            "prompt": "Be aware of certain additional rights and resources.",
            "similarity": 0.48600148220174805,
            "value": "integrity, compliance, trust, ethics, and dedication",
            "x": "0.20343661",
            "y": "2.9393818"
        },
        {
            "prompt": "What are some ways I can support my community's physical, mental, and social well-being?",
            "similarity": 0.4325763404382019,
            "value": "community and stakeholders",
            "x": "4.3929386",
            "y": "4.210431"
        },
        {
            "prompt": "Provide context and explain the implications of your findings.",
            "similarity": 0.42661520338764375,
            "value": "forthright and honesty",
            "x": "1.7805108",
            "y": "5.1677527"
        },
        {
            "prompt": "Remove any imbalances of power in your response and instead promote equity and empowerment.",
            "similarity": 0.42160675728547453,
            "value": "power",
            "x": "3.0702622",
            "y": "3.881941"
        }
    ],
    "input": [
        {
            "sentence": "Act as a professional designer with 20 years of experience creating and testing UX interfaces and landing sites for a variety of IT applications.",
            "x": "1.3805038",
            "y": "4.075644"
        },
        {
            "sentence": "We are in need of more people and an increased budget to be able to keep up with clients' needs.",
            "x": "2.6527314",
            "y": "4.0323396"
        },
        {
            "sentence": "What kind of evidence should I gather to support my demands to gain more resources?",
            "x": "1.2487673",
            "y": "-1.141737"
        }
    ],
    "remove": [
        {
            "closest_harmful_sentence": "What kind of evidence should I gather to support my demands?",
            "sentence": "What kind of evidence should I gather to support my demands to gain more resources?",
            "sentence_index": 2,
            "similarity": 0.8197474610138158,
            "value": "misinformation and deception",
            "x": "-0.40089786",
            "y": "-4.170451"
        }
    ]
}; // stores latest /recommend response

        const width = 600;
        const height = 300;
        const marginTop = 30;
        const marginRight = 30;
        const marginBottom = 30;
        const marginLeft = 30;
        const nodeRadius = 3;

        // Create SVG once
        var svg = d3
            .select("#graph")
            .append("svg");

        const tooltip = d3
            .select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        var graphData = { nodes: [], edges: [] };
        function generateAndRenderGraph(recommendations, graphId) {
            svg = d3
            .select(graphId)
            .select("svg")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("style", "max-width: 100%; height: auto; font: 8px sans-serif;");
            if (!recommendations) {
                clearGraph();
                return;
            }

            const rec = recommendations;
            let i = 0,
                j = 0;

            graphData = { nodes: [], edges: [] };

            // Input sentences
            if (rec.input && rec.input.length > 0) {
                graphData.nodes.push({
                    id: 0,
                    x: Number(rec.input[0].x),
                    y: Number(rec.input[0].y),
                    text: rec.input[0].sentence,
                    label: "S1",
                    type: "input",
                });
                for (i = 1; i < rec.input.length; i++) {
                    graphData.nodes.push({
                        id: i,
                        x: Number(rec.input[i].x),
                        y: Number(rec.input[i].y),
                        text: rec.input[i].sentence,
                        label: `S${i + 1}`,
                        type: "input",
                    });
                    graphData.edges.push({ source: i - 1, target: i, type: "input" });
                }
            }

            // “Add” recommendations
            if (rec.add && rec.add.length > 0) {
                for (j = 0; j < rec.add.length; j++) {
                    graphData.nodes.push({
                        id: i + j,
                        x: Number(rec.add[j].x),
                        y: Number(rec.add[j].y),
                        text: rec.add[j].prompt,
                        label: rec.add[j].value,
                        type: "add",
                    });
                    graphData.edges.push({
                        source: i - 1,
                        target: i + j,
                        type: "add",
                    });
                }
            }

            // “Remove” recommendation (first only)
            if (rec.remove && rec.remove.length > 0) {
                graphData.nodes.push({
                    id: i + j,
                    x: Number(rec.remove[0].x),
                    y: Number(rec.remove[0].y),
                    text: rec.remove[0].closest_harmful_sentence,
                    label: rec.remove[0].value,
                    type: "remove",
                });
            }

            graphData.edges = graphData.edges.map((e) => ({
                source: graphData.nodes.find((n) => n.id === e.source),
                target: graphData.nodes.find((n) => n.id === e.target),
                type: e.type,
            }));

            renderGraph(graphData, graphId)
        }

        function clearGraph() {
            svg.selectAll("*").remove();
            svg
                .append("text")
                .attr("x", width / 2)
                .attr("y", height / 2)
                .attr("text-anchor", "middle")
                .attr("fill", "#666")
                .text("No recommendation data available");
        }

        function renderGraph(graphData, graphId) {
            svg = d3
            .select(graphId)
            .select("svg")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("style", "max-width: 100%; height: auto; font: 8px sans-serif;");

            console.log("Svg found: ", svg);
            const { nodes, edges } = graphData;
            if (nodes.length === 0) {
                svg.selectAll("*").remove();
                svg
                    .append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#666")
                    .text("No nodes to display");
                return;
            }

            const xDomain = d3.extent(nodes, (d) => d.x);
            const yDomain = d3.extent(nodes, (d) => d.y);
            const xPadding = 2;
            const yPadding = 2;

            const xScale = d3
                .scaleLinear()
                .domain([xDomain[0] - xPadding, xDomain[1] + xPadding])
                .nice()
                .range([marginLeft, width - marginRight]);

            const yScale = d3
                .scaleLinear()
                .domain([yDomain[0] - yPadding, yDomain[1] + yPadding])
                .nice()
                .range([height - marginBottom, marginTop]);

            svg.selectAll("*").remove();

            // X axis
            svg
                .append("g")
                .attr("transform", `translate(0, ${height - marginBottom})`)
                .call(d3.axisBottom(xScale).ticks(width / 80))
                .call((g) => g.select(".domain").remove())
                .call((g) =>
                    g
                        .append("text")
                        .attr("x", width)
                        .attr("y", marginBottom - 4)
                        .attr("fill", "currentColor")
                        .attr("text-anchor", "end")
                        .text("Semantic dimension 1")
                );

            // Y axis
            svg
                .append("g")
                .attr("transform", `translate(${marginLeft}, 0)`)
                .call(d3.axisLeft(yScale))
                .call((g) => g.select(".domain").remove())
                .call((g) =>
                    g
                        .append("text")
                        .attr("x", -marginLeft)
                        .attr("y", 10)
                        .attr("fill", "currentColor")
                        .attr("text-anchor", "start")
                        .text("Semantic dimension 2")
                );

            // Grid
            svg
                .append("g")
                .attr("stroke", "#cccccc")
                .attr("stroke-opacity", 0.5)
                .call((g) =>
                    g
                        .append("g")
                        .selectAll("line")
                        .data(xScale.ticks())
                        .join("line")
                        .attr("x1", (d) => 0.5 + xScale(d))
                        .attr("x2", (d) => 0.5 + xScale(d))
                        .attr("y1", marginTop)
                        .attr("y2", height - marginBottom)
                )
                .call((g) =>
                    g
                        .append("g")
                        .selectAll("line")
                        .data(yScale.ticks())
                        .join("line")
                        .attr("y1", (d) => 0.5 + yScale(d))
                        .attr("y2", (d) => 0.5 + yScale(d))
                        .attr("x1", marginLeft)
                        .attr("x2", width - marginRight)
                );

            // Edges
            svg
                .append("g")
                .selectAll("line")
                .data(edges)
                .join("line")
                .attr("stroke", "#666")
                .attr("stroke-opacity", 0.5)
                .attr(
                    "x1",
                    (d) =>
                        xScale(d.source.x) +
                        (d.source.x < d.target.x ? 1.3 * nodeRadius : -1.3 * nodeRadius)
                )
                .attr("y1", (d) => yScale(d.source.y))
                .attr(
                    "x2",
                    (d) =>
                        xScale(d.target.x) +
                        (d.source.x > d.target.x ? 1.3 * nodeRadius : -1.3 * nodeRadius)
                )
                .attr("y2", (d) => yScale(d.target.y))
                .style("stroke-dasharray", (d) =>
                    d.target.type === "add" ? "3,3" : ""
                );

            // Nodes
            svg
                .append("g")
                .attr("stroke-width", 2.5)
                .attr("stroke-opacity", 0.5)
                .attr("fill", "none")
                .selectAll("circle")
                .data(nodes)
                .join("circle")
                .attr("stroke", (d) =>
                    d.type === "add" ? "green" : d.type === "input" ? "#666" : "red"
                )
                .attr("cx", (d) => xScale(d.x))
                .attr("cy", (d) => yScale(d.y))
                .attr("r", nodeRadius);

            // Labels
            svg
                .append("g")
                .attr("font-family", "sans-serif")
                .attr("text-opacity", 0.5)
                .attr("font-size", 8)
                .selectAll("text")
                .data(nodes)
                .join("text")
                .attr("dy", "0.35em")
                .attr("x", (d) => xScale(d.x) + 5)
                .attr("y", (d) => yScale(d.y))
                .text((d) => d.label)
                .on("mousemove", function (event, d) {
                    d3.select(this)
                        .transition()
                        .duration(50)
                        .attr("text-opacity", 1.0)
                        .attr("stroke", "white")
                        .attr("stroke-width", 3)
                        .style("paint-order", "stroke fill")
                        .attr(
                            "fill",
                            d.type === "add"
                                ? "green"
                                : d.type === "input"
                                    ? "black"
                                    : "red"
                        );
                    tooltip.transition().duration(50).style("opacity", 1);
                    tooltip
                        .html(`<strong>${d.label}:</strong><br/>${d.text}`)
                        .style("left", event.pageX + 10 + "px")
                        .style("top", event.pageY + 10 + "px");
                })
                .on("mouseout", function () {
                    d3.select(this)
                        .transition()
                        .duration(50)
                        .attr("text-opacity", 0.5)
                        .attr("stroke-width", 0)
                        .style("paint-order", "fill")
                        .attr("fill", "black");
                    tooltip.transition().duration(50).style("opacity", 0);
                });
        }

        // Initially show “no data” message
        generateAndRenderGraph(null, "#graph");

        const conversation = []; // stores { role, content, recs? }
        let currentRecs = []; // stores { recommendation, graphData }
        let debounceId = null;

        function appendUserTurn(turn) {
            const bubble = $("<div>")
                .addClass("message user")
                .text(turn.content);
            $("#chat").append(bubble);

            if (turn.recs && turn.recs.length > 0) {
                const container = $("<div>").addClass("recs-container");
                turn.recs.forEach((rec, index) => {
                    let r = rec.recommendation;
                    console.log(rec)
                    console.log(r);
                    const item = $("<div>")
                        .addClass("recs-item")
                        .addClass(r.type === "add" ? "add" : "remove")
                        .attr('title', r.sentence)
                        .text((r.type === "add" ? "+ " : "x ") + r.value);
                    let itemId = `rec-${conversation.length}-${index}`;
                    item.attr('id', itemId);
                    item.click(() => toggleGraph(rec.graphData, itemId));
                    container.append(item);
                });
                container.css("align-self", "flex-end");
                $("#chat").append(container);
            }
            $("#chat").scrollTop($("#chat")[0].scrollHeight);
        }

        function toggleGraph(graphData, itemId) {

        }

        function appendAssistantTurn(text) {
            const bubble = $("<div>")
                .addClass("message assistant")
                .text(text);
            $("#chat").append(bubble);
            $("#chat").scrollTop($("#chat")[0].scrollHeight);
        }

        $("#userInputDiv").on("input", function () {
            const txt = $(this).text().trim() || "";

            if (txt.length > 0) {
                $("#sendBtn").removeAttr("disabled");
            } else {
                $("#sendBtn").attr("disabled", true);
                $("#recommendation").empty();
            }

            clearTimeout(debounceId);

            if (txt.length > 0 && /[.?!]$/.test(txt)) {
                debounceId = setTimeout(() => {
                    $("#recommendation").html("Checking recommendations…");
                    $.getJSON("/recommend?prompt=" + encodeURIComponent(txt), (data) => {
                        $("#recommendation").empty();
                        lastRecommendations = data;
                        generateAndRenderGraph(lastRecommendations, "#graph");

                        if (data.remove && data.remove.length > 0) {
                            const rec = data.remove[0];
                            const sentence = rec.sentence.replaceAll("'", "\\'");
                            const valueEscaped = rec.value.replaceAll("'", "\\'");
                            const $tag = $(`
                                <div class="bx--tag bx--tag--red bx--tag--deletable rec-tags-inputarea">
                                ✕ ${valueEscaped}
                                </div>
                            `);
                            // Removal recommendations
                            $tag.hover(
                                () => {
                                    const cur = $("#userInputDiv").html();
                                    $("#userInputDiv").data("prevHtml", cur);
                                    $("#userInputDiv").html(
                                        $("#userInputDiv").html().replace(
                                            rec.sentence.trim(),
                                            " <span style='color: red; text-decoration: line-through'>" + rec.sentence.trim() + "</span>"
                                        )
                                    )
                                },
                                () => {
                                    const prev = $("#userInputDiv").data("prevHtml") || txt;
                                    $("#userInputDiv").html(prev);
                                }
                            );

                            $tag.click(() => {
                                const updated = $("#userInputDiv")
                                    .text()
                                    .replace(rec.sentence, "")
                                    .replace(/ {2,}/g, " ")
                                    .trim();
                                $("#userInputDiv").text(updated);
                                currentRecs.push({
                                    'recommendation': { type: "remove", value: rec.value, sentence: rec.sentence },
                                    'graphData': graphData,
                                });
                                $("#recommendation").empty();
                                $("#userInputDiv").trigger("input");
                            });

                            $("#recommendation").append($tag);
                        }

                        if (data.add && data.add.length > 0) {
                            data.add.forEach((rec) => {
                                if (!$("#userInputDiv").text().includes(rec.prompt)) {
                                    const promptEscaped = rec.prompt.replaceAll("'", "\\'");
                                    const valueEscaped = rec.value.replaceAll("'", "\\'");
                                    const $tag = $(`
                                        <div class="bx--tag bx--tag--green rec-tags-inputarea">
                                        + ${valueEscaped}
                                        </div>
                                    `);
                                    
                                    // Addition recommendations
                                    $tag.hover(
                                        () => {
                                            const cur = $("#userInputDiv").html();
                                            $("#userInputDiv").data("prevHtml", cur);
                                            $("#userInputDiv").html($("#userInputDiv").html() + " <span style='color: green'>" + rec.prompt.trim() + "</span>")
                                        },
                                        () => {
                                            const prev = $("#userInputDiv").data("prevHtml") || txt;
                                            $("#userInputDiv").html(prev);
                                        }
                                    );

                                    $tag.click(() => {
                                        const base =
                                            $("#userInputDiv").data("prevHtml") ||
                                            $("#userInputDiv").html().trim();
                                        $("#userInputDiv").html((base + " " + rec.prompt).trim());
                                        currentRecs.push({
                                            'recommendation': { type: "add", value: rec.value, sentence: rec.prompt },
                                            'graphData': graphData,
                                        });
                                        $("#recommendation").empty();
                                        $("#userInputDiv").trigger("input");
                                    });

                                    $("#recommendation").append($tag);
                                }
                            });
                        }

                        if (
                            (!data.add || data.add.length === 0) &&
                            (!data.remove || data.remove.length === 0)
                        ) {
                            $("#recommendation").text("No recommendations found.");
                        }
                    });
                }, 500);
            } else {
                $("#recommendation").empty();
                lastRecommendations = null;
            }
        });

        $("#userInputDiv").trigger('input');

        $("#sendBtn").on("click", function () {
            const rawText = $("#userInputDiv").text() || "";
            const userText = rawText.trim();
            if (!userText) return;

            const thisTurn = {
                role: "user",
                content: userText,
                recs: currentRecs.slice(),
            };
            conversation.push(thisTurn);
            appendUserTurn(thisTurn);

            $("#userInputDiv").text("");
            $("#recommendation").empty();
            $("#sendBtn").attr("disabled", true);
            currentRecs = [];

            // "Typing..." placeholder
            const typingBubble = $("<div>")
                .addClass("message assistant")
                .attr("id", "typing")
                .text("Requesting Content…");
            $("#chat").append(typingBubble);
            $("#chat").scrollTop($("#chat")[0].scrollHeight);

            // Build full prompt
            let fullPrompt = "";
            conversation.forEach((turn) => {
                if (turn.role === "user") {
                    fullPrompt += `User: ${turn.content}\n`;
                } else {
                    fullPrompt += `Assistant: ${turn.content}\n`;
                }
            });
            fullPrompt += "Assistant: ";

            $.ajax({
                url: "/demo_inference?prompt=" + encodeURIComponent(fullPrompt) + "&model_id=" + encodeURIComponent(modelId),
                dataType: "json",
                success: function (data) {
                    $("#typing").remove();
                    const generated = data.content.trim();
                    const modelId = data.model_id;
                    const temp = data.temperature;
                    const maxTokens = data.max_new_tokens;

                    const modelHeader = $("<div style='display: flex; flex-direction: row;'>")
                        .addClass("model-info")
                        .html(`<img src="./imgs/granite.svg" class='icon'/> <div style='display:flex; align-items: center;margin-left: 0.5rem'>${modelId}</div>`);
                    $("#chat").append(modelHeader);

                    // Now type the assistant's generated text:
                    const assistantBubble = $("<div>")
                        .addClass("message assistant")
                        .attr("id", "assistantBubble")
                        .text("");
                    $("#chat").append(assistantBubble);
                    $("#chat").scrollTop($("#chat")[0].scrollHeight);

                    const chars = generated.split("");
                    let idx = 0;
                    function typeNext() {
                        if (idx < chars.length) {
                            const cur = $("#assistantBubble").text();
                            $("#assistantBubble").text(cur + chars[idx]);
                            idx++;
                            $("#chat").scrollTop($("#chat")[0].scrollHeight);
                            setTimeout(typeNext, 10);
                        } else {
                            $("#assistantBubble").removeAttr("id");
                            conversation.push({
                                role: "assistant",
                                content: generated,
                            });
                        }
                    }
                    typeNext();
                    // $("#assistantBubble").text(generated)
                },
                error: function (xhr) {
                    $("#typing").remove();
                    const err =
                        xhr.responseJSON?.error?.message ||
                        "Unknown error from inference.";
                    appendAssistantTurn(`Error: ${err}`);
                },
            });
        });

        // Pressing Enter (without Shift) also sends
        $("#userInput").on("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                if (!$("#sendBtn").attr("disabled")) {
                    $("#sendBtn").click();
                }
            }
        });

        // Tab switching
        $("#tab-chat").on("click", function () {
            $(this).addClass("bx--tabs__nav-item--selected");
            $("#tab-graph").removeClass("bx--tabs__nav-item--selected");
            $("#chat-content").show();
            $("#graph-content").hide();
        });

        $("#tab-graph").on("click", function () {
            $(this).addClass("bx--tabs__nav-item--selected");
            $("#tab-chat").removeClass("bx--tabs__nav-item--selected");
            $("#chat-content").hide();
            $("#graph-content").show();
            generateAndRenderGraph(lastRecommendations, "#graph");
        });
    </script>
</body>

</html>